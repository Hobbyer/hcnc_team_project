<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="admin.mapper.PromotionMapper">

	<select id="selectNewMemListByAdmin" parameterType="map" resultType="map">
	   SELECT
		    c.MEMBER_ID,
		    c.COUPON_CODE,
		    c.COUPON_TYPE,
		    c.ISSUED_DT,
		    c.EXPIRY_DT,
		    '발급' AS ISSUED_STATUS,
		    c.IS_USED,
		    c.PROMOTION_ID
		FROM COUPONS c
		LEFT JOIN PROMOTIONS p
		    ON c.PROMOTION_ID = p.PROMOTION_ID
		WHERE c.COUPON_TYPE = 'WELCOME'
		ORDER BY ISSUED_DT DESC
	</select>

    <!-- 프로모션 목록 조회 -->
    <select id="selectPromoListByAdmin" parameterType="map" resultType="map">
	    SELECT 
	         p.PROMOTION_ID
	        ,p.PROMOTION_NAME
	        ,p.PROMOTION_TYPE
	        ,p.DESCRIPTION
	        ,p.START_DT
	        ,p.END_DT
	        ,p.IS_ACTIVE
	        ,p.INPUT_DT
	        ,p.UPDATE_DT
	        ,p.INPUT_ID
	        ,p.UPDATE_ID
	        ,p.AUTO_ISSUED
	        ,pc.P_COUPON_CODE
	        ,pc.ISSUED_DT
	        ,pc.EXPIRY_DT
	        ,pc.IS_USED
	        ,pc.PERIOD_SETTING
	        ,pd.DISCOUNT_ID
	        ,pd.DISCOUNT_TYPE
	        ,pd.DISCOUNT_VALUE
	        ,pd.MIN_ORDER_PRICE
	        ,pt.TARGET_ID
	        ,pt.TARGET_TYPE
	        ,pt.TARGET_VALUE
	        ,pt.TARGET_AMOUNT
	    FROM PROMOTIONS p
	    LEFT JOIN PROMOTION_COUPON pc ON p.PROMOTION_ID = pc.PROMOTION_ID
	    LEFT JOIN PROMOTION_DISCOUNT pd ON p.PROMOTION_ID = pd.PROMOTION_ID  
	    LEFT JOIN PROMOTION_TARGET pt ON p.PROMOTION_ID = pt.PROMOTION_ID
	    <where>
	        <if test="PROMOTION_NAME != null and PROMOTION_NAME != ''">
	            AND p.PROMOTION_NAME LIKE CONCAT('%', #{PROMOTION_NAME}, '%')
	        </if>
	        <if test="PROMOTION_TYPE != null and PROMOTION_TYPE != ''">
	            AND p.PROMOTION_TYPE = #{PROMOTION_TYPE}
	        </if>
	        <if test="TARGET_VALUE != null and TARGET_VALUE != '' and TARGET_VALUE != 'all'">
	            AND pt.TARGET_VALUE = #{TARGET_VALUE}
	        </if>
	        <if test="progressStatus != null and progressStatus != ''">
	            <choose>
	                <when test="progressStatus == 'Y'">
	                    AND NOW() BETWEEN p.START_DT AND p.END_DT
	                </when>
	                <when test="progressStatus == 'N'">
	                    AND (NOW() &lt; p.START_DT OR NOW() &gt; p.END_DT)
	                </when>
	            </choose>
	        </if>
	        <!-- "all"이 아닐 때만 조건 추가 -->
	        <if test="IS_ACTIVE != null and isActive != '' and IS_ACTIVE != 'all'">
	            AND p.IS_ACTIVE = #{IS_ACTIVE}
	        </if>
	        <if test="START_DT != null and START_DT != ''">
	            AND p.START_DT &gt;= #{START_DT}
	        </if>
	        <if test="END_DT != null and END_DT != ''">
	            AND p.END_DT &lt;= #{END_DT}
	        </if>
	    </where>
	    ORDER BY p.PROMOTION_ID DESC
	</select>

	<select id="selectPromoViewByAdmin" parameterType="String" resultType="map">
	    SELECT 
	         p.PROMOTION_ID
	        ,p.PROMOTION_NAME
	        ,p.PROMOTION_TYPE
	        ,p.DESCRIPTION
	        ,p.START_DT
	        ,p.END_DT
	        ,p.IS_ACTIVE
	        ,p.INPUT_DT
	        ,p.UPDATE_DT
	        ,p.INPUT_ID
	        ,p.UPDATE_ID
	        ,p.AUTO_ISSUED 	        
	        ,pc.P_COUPON_CODE
	        ,pc.ISSUED_DT
	        ,pc.EXPIRY_DT
	        ,pc.PERIOD_SETTING 	        
	        ,pd.DISCOUNT_ID
	        ,pd.DISCOUNT_TYPE
	        ,pd.DISCOUNT_VALUE
	        ,pd.MIN_ORDER_PRICE 	
	        ,pt.TARGET_ID
	        ,pt.TARGET_TYPE
	        ,pt.TARGET_VALUE
	        ,pt.TARGET_AMOUNT
	    FROM PROMOTIONS p
	    LEFT JOIN PROMOTION_COUPON pc ON p.PROMOTION_ID = pc.PROMOTION_ID
	    LEFT JOIN PROMOTION_DISCOUNT pd ON p.PROMOTION_ID = pd.PROMOTION_ID  
	    LEFT JOIN PROMOTION_TARGET pt ON p.PROMOTION_ID = pt.PROMOTION_ID
	    WHERE p.PROMOTION_ID = #{promotionId}
	</select>

	<!-- 프로모션 기본 정보 등록 -->
	<insert id="insertPromoBaseByAdmin" parameterType="java.util.Map">
	    <selectKey resultType="long" keyProperty="promotionId" order="AFTER">
	        SELECT LAST_INSERT_ID()
	    </selectKey>
	    INSERT INTO PROMOTIONS(
	        PROMOTION_NAME
	        ,PROMOTION_TYPE
	        ,DESCRIPTION
	        ,START_DT
	        ,END_DT
	        ,IS_ACTIVE
	        ,AUTO_ISSUED
	        ,INPUT_DT
	        ,UPDATE_DT
	        ,INPUT_ID
	        ,UPDATE_ID
	    )VALUES(
	        #{PROMOTION_NAME}
	        ,#{PROMOTION_TYPE}
	        ,#{DESCRIPTION}
	        ,#{START_DT}
	        ,#{END_DT}
	        ,#{IS_ACTIVE}
	        ,#{AUTO_ISSUED}
	        ,NOW()
	        ,NOW()
	        ,#{INPUT_ID}
	        ,#{INPUT_ID}
	    )
	</insert>
	
	<!-- 프로모션 할인 정보 등록 -->
	<insert id="insertPromoDiscountByAdmin" parameterType="java.util.Map">
	    INSERT INTO PROMOTION_DISCOUNT(
	        PROMOTION_ID
	        ,DISCOUNT_TYPE
	        ,DISCOUNT_VALUE
	        ,MIN_ORDER_PRICE
	        ,INPUT_DT
	        ,UPDATE_DT
	        ,INPUT_ID
	        ,UPDATE_ID
	    )VALUES(
	        #{promotionId}
	        ,#{DISCOUNT_TYPE}
	        ,#{DISCOUNT_VALUE}
	        ,#{MIN_ORDER_PRICE}
	        ,NOW()
	        ,NOW()
	        ,#{INPUT_ID}
	        ,#{INPUT_ID}
	    )
	</insert>
	
	<!-- 프로모션 대상 정보 등록 -->
	<insert id="insertPromoTargetByAdmin" parameterType="java.util.Map">
	    INSERT INTO PROMOTION_TARGET(
	        PROMOTION_ID
	        ,TARGET_TYPE
	        ,TARGET_VALUE
	        ,TARGET_AMOUNT
	        ,INPUT_DT
	        ,UPDATE_DT
	        ,INPUT_ID
	        ,UPDATE_ID
	    )VALUES(
	        #{promotionId}
	        ,#{TARGET_TYPE}
	        ,#{TARGET_VALUE}
	        ,#{TARGET_AMOUNT}
	        ,NOW()
	        ,NOW()
	        ,#{INPUT_ID}
	        ,#{INPUT_ID}
	    )
	</insert>
	
	<!-- 프로모션 쿠폰 정보 등록 -->
	<insert id="insertPromoCouponByAdmin" parameterType="java.util.Map">
	    INSERT INTO PROMOTION_COUPON(
	        PROMOTION_ID
	        ,P_COUPON_CODE
	        ,EXPIRY_DT
	        ,PERIOD_SETTING
	    )VALUES(
	        #{promotionId}
	        ,#{P_COUPON_CODE}
	        ,#{EXPIRY_DT}
	        ,#{PERIOD_SETTING}
	    )
	</insert>
	
	<!-- 프로모션 기본 정보 수정 -->
	<update id="updatePromoBaseByAdmin" parameterType="java.util.Map">
	    UPDATE PROMOTIONS SET
	         PROMOTION_NAME = #{PROMOTION_NAME}
	        ,PROMOTION_TYPE = #{PROMOTION_TYPE}
	        ,DESCRIPTION = #{DESCRIPTION}
	        ,START_DT = #{START_DT}
	        ,END_DT = #{END_DT}
	        ,IS_ACTIVE = #{IS_ACTIVE}
	        ,AUTO_ISSUED = #{AUTO_ISSUED}
	        ,UPDATE_DT = NOW()
	        ,UPDATE_ID = #{UPDATE_ID}
	    WHERE PROMOTION_ID = #{PROMOTION_ID}
	</update>
	
	<!-- 프로모션 할인 정보 수정 -->
	<update id="updatePromoDiscountByAdmin" parameterType="java.util.Map">
	    UPDATE PROMOTION_DISCOUNT SET
	         DISCOUNT_TYPE = #{DISCOUNT_TYPE}
	        ,DISCOUNT_VALUE = #{DISCOUNT_VALUE}
	        ,MIN_ORDER_PRICE = #{MIN_ORDER_PRICE}
	        ,UPDATE_DT = NOW()
	        ,UPDATE_ID = #{UPDATE_ID}
	    WHERE PROMOTION_ID = #{PROMOTION_ID}
	</update>
	
	<!-- 프로모션 대상 정보 수정 -->
	<update id="updatePromoTargetByAdmin" parameterType="java.util.Map">
	    UPDATE PROMOTION_TARGET SET
	         TARGET_TYPE = #{TARGET_TYPE}
	        ,TARGET_VALUE = #{TARGET_VALUE}
	        ,TARGET_AMOUNT = #{TARGET_AMOUNT}
	        ,UPDATE_DT = NOW()
	        ,UPDATE_ID = #{UPDATE_ID}
	    WHERE PROMOTION_ID = #{PROMOTION_ID}
	</update>
	
	<!-- 프로모션 쿠폰 정보 수정 -->
	<update id="updatePromoCouponByAdmin" parameterType="java.util.Map">
	    UPDATE PROMOTION_COUPON SET
	         P_COUPON_CODE = #{P_COUPON_CODE}
	        ,EXPIRY_DT = #{EXPIRY_DT}
	        ,PERIOD_SETTING = #{PERIOD_SETTING}
	    WHERE PROMOTION_ID = #{PROMOTION_ID}
	</update>

</mapper>