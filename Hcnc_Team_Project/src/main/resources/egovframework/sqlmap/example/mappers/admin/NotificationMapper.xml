<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="admin.mapper.NotificationMapper">
	
	<select id="selectUnreadCountByCommon" parameterType="map" resultType="int">
	#안읽은 메세지 개수 
		SELECT COUNT(*) 
		  FROM TB_NOTIFICATION 
		  WHERE 1=1
		  <if test="userId!= null and userId!=''">
		   AND RECEIVER_ID = #{userId}
		 </if>
		   AND RECEIVER_TYPE = #{receiverType}
		   AND READ_YN = 'N'
	</select>
	
	<select id="selectNotificationList" parameterType="map" resultType="map">
	#알림 리스트
		SELECT NOTI_MESSAGE
		     , NOTI_ID
		     , DATE_FORMAT(REG_DATE, '%Y-%m-%d') AS REG_DATE
		     , READ_YN
		  FROM TB_NOTIFICATION
		 WHERE 1=1
		  <if test="userId!= null and userId!=''">
		   AND RECEIVER_ID = #{userId}
		 </if>
		   AND RECEIVER_TYPE = #{receiverType}
		   AND READ_YN = 'N'
	</select>
	
	<update id="updateReadStatus" parameterType="map">
		UPDATE TB_NOTIFICATION
		   SET READ_YN = 'Y'
		     , READ_DATE = NOW()
		 WHERE 1=1
		 	<if test="userId!=null and userId!=''">
		   AND RECEIVER_ID = #{userId}
		 	</if>
		 	<if test="receiverType!=null and receiverType!=''">
		   AND RECEIVER_TYPE = #{receiverType}
		 	</if> 
		   AND NOTI_ID = #{notiId}
	</update>
	
	<insert id="insertNotificationByAdmin" parameterType="map">
		INSERT INTO TB_NOTIFICATION (
			NOTI_ID,
			SENDER_ID,
			RECEIVER_ID,
			RECEIVER_TYPE,
			NOTI_TYPE,
			NOTI_MESSAGE,
			ORDER_NO,
			ORDER_STATUS,
			REG_DATE
		) VALUES (
			CONCAT('NOTI_', DATE_FORMAT(NOW(), '%Y%m%d%H%i%s'), LPAD(FLOOR(RAND() * 1000), 3, '0')),
			#{senderId},
			#{receiverId},
			#{receiverType},
			#{notiType},
			#{notiMessage},
			#{orderNo},
			#{orderStatus},
			NOW()
		)
	</insert>
	<insert id="insertNotificationOneByUser" parameterType="map">
	INSERT INTO TB_NOTIFICATION(
			NOTI_ID,
			SENDER_ID,
			RECEIVER_ID,
			RECEIVER_TYPE,
			NOTI_TYPE,
			NOTI_MESSAGE,
			REG_DATE
		) VALUES (
			CONCAT('NOTI_', DATE_FORMAT(NOW(), '%Y%m%d%H%i%s'), LPAD(FLOOR(RAND() * 1000), 3, '0')),
			#{senderId},
			#{receiverId},
			#{receiverType},
			#{notiType},
			#{notiMessage},
			NOW()
		)
	</insert>
	
		<insert id="insertNotificationOneByAdmin" parameterType="map">
		INSERT INTO TB_NOTIFICATION (
			NOTI_ID,
			SENDER_ID,
			RECEIVER_ID,
			RECEIVER_TYPE,
			NOTI_TYPE,
			NOTI_MESSAGE,
			REG_DATE
		) VALUES (
			CONCAT('NOTI_', DATE_FORMAT(NOW(), '%Y%m%d%H%i%s'), LPAD(FLOOR(RAND() * 1000), 3, '0')),
			#{senderId},
			#{receiverId},
			#{receiverType},
			#{notiType},
			#{notiMessage},
			NOW()
		)
	</insert>
	
</mapper>